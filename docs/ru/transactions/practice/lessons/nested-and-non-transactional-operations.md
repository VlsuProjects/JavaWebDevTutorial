## Урок 4: Реализация вложенных транзакций и операций без транзакции

## Цель

Этот раздел направлен на изучение использования вложенных транзакций и операций без транзакции в слое сервиса, обеспечивая студентам понимание управления сложными транзакционными сценариями.

## Шаги

1. **Обновление деталей курса и зачислений**

   **Сценарий**: В качестве администратора университета вам часто приходится обновлять как детали курса, так и зачисления, связанные с этим курсом. Эта операция должна обеспечивать целостность и непрерывность данных, даже если происходит несколько обновлений одновременно.

   **Реализация метода `updateCourseAndEnrollments`**: Определите метод для обновления деталей курса и зачислений с необходимым транзакционным поведением. Мы используем `Propagation.REQUIRED`, чтобы убедиться, что этот метод участвует в любой существующей транзакции или создает новую, если таковой не существует. Установка `Isolation.REPEATABLE_READ` гарантирует, что данные, считываемые этим методом, остаются согласованными на протяжении всей транзакции. Внутри этого метода мы выполняем вложенную транзакцию, вызывая метод `updateEnrollments` для обновления зачислений, обеспечивая атомарность и изоляцию этой операции от внешней транзакции.

   ```java
   @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.REPEATABLE_READ)
   public void updateCourseAndEnrollments(UUID courseId, String newTitle) {
       // Запись начала процесса обновления
       logAction("Update Course and Enrollments", "Start");

       try {
           // Реализация обновления деталей курса
           // ...

           // Вложенная транзакция для обновления зачислений
           updateEnrollments(courseId);

           // Запись успешного обновления
           logAction("Update Course and Enrollments", "Success");
       } catch (Exception e) {
           // Запись неудачи
           logAction("Update Course and Enrollments", "Failure: " + e.getMessage());
           throw e;
       }
   }
   ```

2. **Обновление зачислений независимо**

   **Сценарий**: Некоторые административные задачи могут потребовать обновления зачислений независимо от обновлений курса. Эта операция должна поддерживать целостность данных, позволяя при этом отдельное транзакционное управление.

   **Реализация метода `updateEnrollments`**: Определите метод для обновления зачислений для курса с вложенным транзакционным поведением. Мы используем `Propagation.NESTED`, чтобы указать, что этот метод выполняется в рамках внешней транзакции, но может быть отменен независимо при необходимости. Установка `Isolation.REPEATABLE_READ` гарантирует, что данные, считываемые этим методом, остаются согласованными на протяжении всей транзакции.

   ```java
   @Transactional(propagation = Propagation.NESTED, isolation = Isolation.REPEATABLE_READ)
   public void updateEnrollments(UUID courseId) {
       // Запись начала процесса обновления зачислений
       logAction("Update Enrollments", "Start");

       try {
           // Реализация обновления зачислений
           // ...

           // Запись успешного обновления
           logAction("Update Enrollments", "Success");
       } catch (Exception e) {
           // Запись неудачи
           logAction("Update Enrollments", "Failure: " + e.getMessage());
           throw e;
       }
   }
   ```

---

# [ДАЛЕЕ: Задания](../../lab-work.md)
